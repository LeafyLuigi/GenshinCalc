<!DOCTYPE html>
<html>
	<head>
		<title>Genshin Calculator - Inventory</title>
		<link rel="stylesheet" href="style.css">
		<script type="text/javascript" src="loadData.js"></script>
		<script type="text/javascript" src="ascdb.js"></script>
		<script type="text/javascript" src="scripts.js"></script>
		<script type="text/javascript" src="scripts/cookieLocalStorage.js"></script>
		<script type="text/javascript" src="scripts/prefs.js"></script>
		<script type="text/javascript" src="scripts/inventory.js"></script>
		<script type="text/javascript" src="scripts/charWeapHandling.js"></script>
	</head>
	<body>
		<noscript>You need to enable JavaScript to use this page. It's all open source and no data is sent between this site and third parties. <a href="https://github.com/LeafyLuigi/GenshinCalc">Click here to view the GitHub Repo.</a></noscript>
		<div id="links"></div>
		<div id="prefsContainer"></div>
		<div class="invBlock" id="inventory">
			<div class="boxName">Inventory</div>
			<p>
				<em>You can hold Shift to adjust by 10 or CTRL (CMD on Mac) to adjust by 100.</em>
				<span>You can clear your inventory by clicking the button at the bottom of the page.</span>
			</p>
			<br>
			<div class="outputRequired" id="items">
				<div id="loading">
					<span class="loadingText">Loading...</span>
					<img class="loadingSpin" src="images/icons/loading.svg" height="64" width="64">
				</div>
			</div>
			<br>
			<div id="clearinvbutton" class="fauxButton clearInvButton">Clear Inventory</div>
		</div>
	</body>
	<script>
	'use strict';
	pageType = "inventory";
	var inv = parseLSItem("inv",{})
	
	async function loadPage() {
		get("clearinvbutton").addEventListener("click",e=>clearInventory());

		await loadAllPrefs();
		await loadData();
		get("skipLink").href = "#inventory";
		await insertPrefElements({include:["hideExtraIcons","themeDropdown"]});

		var itemKeys = [];
		for(let i in itemDB) {
			// if(itemDB[i].include == false) continue;
			itemKeys.push(i);
		}
		orderItems(itemKeys);
		for(let i in itemKeys) {
			var value = 0;
			if(inv[itemKeys[i]]) {
				value = inv[itemKeys[i]];
			}
			newItem(itemKeys[i],value);
		}
		get("items").removeChild(get("loading"));
	};

	function newItem(item,value) {
		var type = itemDB[item].type;
		let img = spaceToUnderscore(item);
		let rarity = itemDB[item].rarity;

		let wrapper = Object.assign(document.createElement("div"));
		wrapper.classList.add("askForItem");
		
		let container = Object.assign(document.createElement("div"));
		container.classList.add("itemIconContainer");
		container.classList.add("mini");
		
		let iconElemContainer = Object.assign(document.createElement("div"));
		iconElemContainer.classList.add("itemIcon");
		if(rarity !== undefined) {
			iconElemContainer.classList.add("rarity-"+rarity);
		} else {
			iconElemContainer.classList.add("rarity-0");
		}

		// crown item is placed in "other" directory
		if(type === "crown") {
			type="other";
		}

		let elemItemImg = Object.assign(document.createElement("img"));
		elemItemImg.src = "images/"+type+"/"+img+".png";
		elemItemImg.height = 72;
		elemItemImg.width = 72;
		elemItemImg.classList.add("itemIconImg");
		iconElemContainer.appendChild(elemItemImg)

		if(rarity !== undefined && rarity !== 0) {
			let rarityIcon = Object.assign(document.createElement("img"));
			rarityIcon.classList.add("rarityIcon");
			rarityIcon.classList.add("extraIcon");
			rarityIcon.src = "images/icons/rarity/"+rarity+".png";
			rarityIcon.setAttribute("draggable", "false");
			rarityIcon.setAttribute("loading", "lazy");

			iconElemContainer.appendChild(rarityIcon)
		}

		let input = Object.assign(document.createElement("input"));
		input.classList.add("userInvInput");
		input.type = "number";
		input.setAttribute("min","0");
		input.value = value;
		input.setAttribute("id","userItemCount"+spaceToUnderscore(item));
		input.addEventListener("wheel",function(e) {
			adjustStep(e.currentTarget.id,true);
		});
		input.addEventListener("keydown",function(e) {
			adjustStep(e.currentTarget.id);
		});
		input.addEventListener("change",function(e) {
			saveItem(e.currentTarget);
		});

		iconElemContainer.appendChild(input);

		if (itemDB[item].source !== undefined) {
			let sourceImg = Object.assign(document.createElement("img"));
			sourceImg.classList.add("itemSource");
			sourceImg.height = 20;
			sourceImg.width = 20;
			sourceImg.src = "images/icons/info.svg";
			sourceImg.setAttribute("tabindex","0");
			sourceImg.setAttribute("draggable", "false");
			sourceImg.setAttribute("loading", "lazy");
			sourceImg.addEventListener("click", function (e) {
				toggleClass(e.currentTarget, "active");
			});
			iconElemContainer.appendChild(sourceImg)

			let sourceDiv = Object.assign(document.createElement("div"), { textContent: itemDB[item].source });
			sourceDiv.classList.add("itemSourceTooltip");
			iconElemContainer.appendChild(sourceDiv);
		}

		container.appendChild(iconElemContainer);

		let nameContainer = Object.assign(document.createElement("div"),{textContent:item});
		nameContainer.classList.add("itemName");
		container.appendChild(nameContainer);
		wrapper.appendChild(container);

		get("items").appendChild(wrapper);
	}

	function saveItem(element) {
		let itemName = underscoreToSpace(element.id.slice(13))
		let itemCount = element.valueAsNumber
		if(isNaN(itemCount) || itemCount <= 0) {
			delete inv[itemName]
		} else {
			inv[itemName] = itemCount;
		}
		if(JSON.stringify(inv) === "{}") {
			clearLSItem("inv");
		} else {
			setLSItem("inv",JSON.stringify(inv));
		}
	}


	loadPage();
	</script>
</html>